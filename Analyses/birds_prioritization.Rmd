---
title: "RES510"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r ebird}
#load required packages
#library(ebirdst)
#library(auk)
#library(rgbif)
library(dplyr)
library(here)
library(ggplot2)
library(traitdata)
#library(sf)
#library(rnaturalearth)
#library(rnaturalearthdata)
#library(rredlist)

require(dplyr); require(RColorBrewer); require(ggplot2)
#require(mapdata); require(maptools)
```

Simple CSV file

GBIF.org (03 November 2021) GBIF Occurrence Download https://doi.org/10.15468/dl.k49xau
Licence CC BY-NC 4.0
File 3 MB Simple
Involved datasets 15
Make sure to read the data user agreement and citation guidelines.

Darwin Core Archive File

GBIF.org (03 November 2021) GBIF Occurrence Download https://doi.org/10.15468/dl.czeavt
Licence CC BY-NC 4.0
File 9 MB Darwin Core Archive
Involved datasets 15
Make sure to read the data user agreement and citation guidelines.

Species List File

GBIF.org (03 November 2021) GBIF Occurrence Download https://doi.org/10.15468/dl.a3grx5
Licence CC BY-NC 4.0
File 40 KB Species list
Involved datasets 15
Make sure to read the data user agreement and citation guidelines.

Administrative areas (gadm.org) CAN.2.14_1
Geometry POLYGON((-123.26527 49.26797,-123.26697 49.26252,-123.25981 49.25579,-123.2465 49.24606,-123.22908 49.24019,-123.22755 49.24082,-123.22685 49.2431,-123.22804 49.24575,-123.22794 49.24848,-123.22838 49.25076,-123.22928 49.25321,-123.23079 49.25658,-123.23001 49.25815,-123.23161 49.25889,-123.23238 49.26036,-123.22961 49.26188,-123.23067 49.26312,-123.23323 49.26285,-123.23777 49.26755,-123.23936 49.2688,-123.24056 49.27137,-123.242 49.27381,-123.24372 49.2776,-123.24528 49.2805,-123.25933 49.27558,-123.26388 49.272,-123.26527 49.26797))
Scientific name Aves

BC_conserv_status.csv file citation
B.C. Conservation Data Centre. 2021. BC Species and Ecosystems Explorer. B.C. Minist. of Environ. Victoria, B.C. Available: https://a100.gov.bc.ca/pub/eswp/ (accessed Nov 10, 2021).



```{r}
#functions

range01 <- function(x){(x-min(x))/(max(x)-min(x))}
range01 <-function(x, ...) {(x - min(x, ...)) / (max(x, ...) - min(x, ...))}
#theme_set(theme_bw())

#canada <- map_data("worldHires", "Canada")

```

```{r}

here()
birds <- read.delim(here("input","GBIF_birds_UBC.csv"), header = TRUE, sep = "\t")
status <- read.delim(here("input","BC_conserv_status.csv"), header = TRUE, sep = ",")
data("elton_birds")

plot(birds$decimalLongitude, birds$decimalLatitude)

unique(birds$species)

birds_fltr <- birds %>%
  filter(decimalLatitude = TRUE, decimalLongitude = TRUE, year > 1999) %>% #filter for observations with a latitude and longitude, and to year 2000 or more recent
  count(occurrenceStatus, species) %>% #count number of observations per species
  arrange(n) %>% #assign number of observations to "n" variable
  filter(n >= 5) #filter for minimum number of observations allowed, currently 5 (ask a prof?)


# test <- status  %>%
# filter(Scientific.Name == birds_fltr$species)


 birds_list <- left_join(birds_fltr, status, by = c("species" = "Scientific.Name")) %>%  #few species did not have status designation, to be filled in manually later 
  select("occurrenceStatus", "species", "n", "English.Name", "Provincial", "BC.List", "Global") #select columns to retain
 
 birds_list <- left_join(birds_list, elton_birds, by = c("species" = "scientificNameStd")) %>%  #few species did not have status designation, to be filled in manually later 
  select("occurrenceStatus", "species", "n", "English.Name", "Provincial", "BC.List", "Global","Diet.5Cat", "BodyMass.Value")
 
 
 # include higher trophic level first list
 # filter by high trophic level species list
 

 birds_list <-  birds_list %>% #convert global status to number, see: https://www.env.gov.bc.ca/atrisk/help/grank.htm
  mutate(GlobalNum = case_when(
    startsWith(Global, "G5") ~ 1,
    startsWith(Global, "G4") ~ 2,
    startsWith(Global, "G3") ~ 3
    ))

 birds_list  <-  birds_list %>% #convert BC status to number, 0 for all non-native, 1-3 for native, see: https://www.env.gov.bc.ca/atrisk/help/list.htm
  mutate(BCNum = case_when(
    startsWith(BC.List, c("Acc","Exo", "Un" )) ~ 0,
    startsWith(BC.List, "Yel") ~ 1,
    startsWith(BC.List, "Bl") ~ 2,
    startsWith(BC.List, "Red") ~ 3,
    ))

 birds_list  <-  birds_list %>% #convert provincial status to number, 0 for no concern, 4 for critically imperiled. see: https://www.env.gov.bc.ca/atrisk/help/srank.htm 
  mutate(ProvNum = case_when(
    grepl("S1", Provincial) ~ 4,
    grepl("S2", Provincial) ~ 3,
    grepl("S3", Provincial) ~ 2,
    grepl("S4", Provincial) ~ 1,
    grepl("S5", Provincial) ~ 0,
    ))
 
  birds_list  <-  birds_list %>% #convert provincial status to number, 0 for no concern, 4 for critically imperiled. see: https://www.env.gov.bc.ca/atrisk/help/srank.htm 
  mutate(TrophicNum = case_when(
    startsWith(Diet.5Cat, "Vert") ~ 4,
    startsWith(Diet.5Cat, "Inv") ~ 3,
    startsWith(Diet.5Cat, "Omni") ~ 2,
    startsWith(Diet.5Cat, c("Plant", "Frui")) ~ 1,
    ))
  
 
 # birds_list  <-  birds_list %>% #convert provincial status to number, 0 for no concern, 4 for critically imperiled. see: https://www.env.gov.bc.ca/atrisk/help/srank.htm 
#    mutate(ProvNumS = scale(ProvNum)) %>%
#    mutate(GlobalNumS = scale(GlobalNum)) %>%
#    mutate(BCNumS = scale(BCNum)) %>%
  
  

  
# birds_list$ProvNumS = scale(birds_list$ProvNum, na.rm = T)  
# birds_list$GlobalNumS = range01(birds_list$GlobalNum, na.rm = T)  
# birds_list$BCNumS = range01(birds_list$BCNum, na.rm = T)  
# birds_list$nS = scale(birds_list$n) 
# birds_list$TrophicNumS = range01(birds_list$TrophicNum, na.rm = T)  
# birds_list$BodyMassS = range01(birds_list$BodyMass.Value, na.rm = T) 
#   
birds_list$ProvNumS = range01(birds_list$ProvNum, na.rm = T)  
birds_list$GlobalNumS = range01(birds_list$GlobalNum, na.rm = T)  
birds_list$BCNumS = range01(birds_list$BCNum, na.rm = T)  
birds_list$nS = range01((1/birds_list$n), na.rm = T) 
birds_list$TrophicNumS = range01(birds_list$TrophicNum, na.rm = T)  
birds_list$BodyMassS = range01(birds_list$BodyMass.Value, na.rm = T) 

# birds_list$ProvNumS = scale(birds_list$ProvNum)  
# birds_list$GlobalNumS = scale(birds_list$GlobalNum)  
# birds_list$BCNumS = scale(birds_list$BCNum)  
# birds_list$nS = scale(birds_list$n)  
#  
 
 birds_list <-  birds_list %>%
  mutate(score = ProvNumS+BCNumS+GlobalNumS+(nS*-1))
 

 birds_list$score.scale = scale(birds_list$score)
 

birds_list %>%
   mutate(rank = rank(desc(score.scale)))

birds_list_sorted <- birds_list[order(desc(birds_list$score.scale)),]


#########

 birds_list2 <-  birds_list %>%
  mutate(score = ProvNumS*GlobalNumS*nS*TrophicNumS*BodyMassS)
 

 birds_list2$score.scale = scale(birds_list2$score)
 

birds_list2 %>%
   mutate(rank = rank(desc(score.scale)))

birds_list_sorted2 <- birds_list2[order(desc(birds_list2$score.scale)),]

#########
 birds_list2 <-  birds_list %>%
  mutate(score = ProvNumS*(0.5*GlobalNumS)*(0.5*nS)*TrophicNumS*(0.5*BodyMassS))
 

 birds_list2$score.scale = scale(birds_list2$score)
 

birds_list2 %>%
   mutate(rank = rank(desc(score.scale)))

birds_list_sorted2 <- birds_list2[order(desc(birds_list2$score.scale)),]



```


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
